<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteChat Pro V1.0_GM</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --dark: #111b21; --head: #202c33; --green: #00a884; --msg-me: #005c4b; --msg-them: #202c33; --text: #e9edef; }
        body { margin: 0; background: #0b141a; color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 300px; border-right: 1px solid #222d34; display: flex; flex-direction: column; background: var(--dark); }
        .main { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .header { background: var(--head); padding: 10px 15px; display: flex; align-items: center; gap: 10px; min-height: 60px; }
        .chat-item { padding: 12px; border-bottom: 1px solid #222d34; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .chat-item:hover { background: #2a3942; }
        .pfp { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #6a7175; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 70%; position: relative; font-size: 14px; }
        .msg.me { align-self: flex-end; background: var(--msg-me); }
        .msg.them { align-self: flex-start; background: var(--msg-them); }
        .msg-time { font-size: 10px; opacity: 0.6; text-align: right; margin-top: 4px; }
        .input-area { background: var(--head); padding: 10px; display: flex; gap: 10px; }
        input { flex: 1; background: #2a3942; border: none; padding: 10px; border-radius: 20px; color: white; outline: none; }
        button { background: var(--green); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header">
        <img id="my-pfp" class="pfp" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
        <div style="flex:1"><b id="display-name">Loading...</b><br><small id="display-id" style="color:var(--green)"></small></div>
        <button onclick="addFriend()">+</button>
    </div>
    <div id="friend-list"></div>
</div>

<div class="main">
    <div id="chat-header" class="header hidden">
        <img id="target-pfp" class="pfp">
        <b id="target-name"></b>
    </div>
    <div id="messages"></div>
    <form id="chat-form" class="input-area hidden">
        <input type="text" id="msg-input" placeholder="Ketik pesan..." autocomplete="off">
        <button type="submit">Kirim</button>
    </form>
</div>

<script>
    // 1. Ambil data atau registrasi (Langsung tersimpan permanen)
    let myID = localStorage.getItem('wid') || prompt("Masukkan ID:").toLowerCase();
    let myName = localStorage.getItem('wname') || prompt("Masukkan Nama:");
    localStorage.setItem('wid', myID);
    localStorage.setItem('wname', myName);

    // Load Chat History (Inilah kunci agar tidak hilang saat refresh)
    let chats = JSON.parse(localStorage.getItem('chat_history') || '{}');
    let activeChat = null;

    document.getElementById('display-name').innerText = myName;
    document.getElementById('display-id').innerText = "@" + myID;

    const peer = new Peer(myID);

    peer.on('open', () => {
        renderFriends();
    });

    // Menangani pesan masuk
    peer.on('connection', conn => {
        conn.on('data', data => {
            const senderID = conn.peer;
            // Pastikan teman ada di list
            if (!chats[senderID]) chats[senderID] = { name: data.senderName || senderID, logs: [] };
            
            // Simpan pesan
            chats[senderID].logs.push({ side: 'them', text: data.text, time: data.time });
            saveAndRefresh();
        });
    });

    function addFriend() {
        const id = prompt("Masukkan ID Teman:").toLowerCase();
        if (id && id !== myID) {
            if (!chats[id]) chats[id] = { name: id, logs: [] };
            saveAndRefresh();
            openChat(id);
        }
    }

    function openChat(id) {
        activeChat = id;
        document.getElementById('chat-header').classList.remove('hidden');
        document.getElementById('chat-form').classList.remove('hidden');
        document.getElementById('target-name').innerText = chats[id].name;
        document.getElementById('target-pfp').src = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        renderMessages();
    }

    document.getElementById('chat-form').onsubmit = e => {
        e.preventDefault();
        const input = document.getElementById('msg-input');
        if (!input.value || !activeChat) return;

        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const msgData = { 
            text: input.value, 
            time: time, 
            senderName: myName 
        };

        // Simpan ke riwayat sendiri
        chats[activeChat].logs.push({ side: 'me', text: input.value, time: time });
        
        // Kirim ke teman
        const conn = peer.connect(activeChat);
        conn.on('open', () => {
            conn.send(msgData);
            saveAndRefresh();
        });

        input.value = "";
    };

    function saveAndRefresh() {
        localStorage.setItem('chat_history', JSON.stringify(chats));
        renderFriends();
        if (activeChat) renderMessages();
    }

    function renderFriends() {
        const list = document.getElementById('friend-list');
        list.innerHTML = "";
        Object.keys(chats).forEach(id => {
            list.innerHTML += `
                <div class="chat-item" onclick="openChat('${id}')">
                    <img class="pfp" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                    <div><b>${chats[id].name}</b></div>
                </div>`;
        });
    }

    function renderMessages() {
        const container = document.getElementById('messages');
        container.innerHTML = "";
        chats[activeChat].logs.forEach(m => {
            container.innerHTML += `
                <div class="msg ${m.side}">
                    ${m.text}
                    <div class="msg-time">${m.time}</div>
                </div>`;
        });
        container.scrollTop = container.scrollHeight;
    }
</script>
</body>
</html>