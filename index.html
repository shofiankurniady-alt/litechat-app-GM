<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiteChat Pro - GM</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --dark: #111b21; --side: #111b21; --head: #202c33; --green: #00a884; --msg-me: #005c4b; --msg-them: #202c33; --text: #e9edef; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: #0c1317; color: var(--text); height: 100dvh; display: flex; overflow: hidden; }

        /* Sidebar & List */
        .sidebar { width: 30%; min-width: 300px; border-right: 1px solid #222d34; display: flex; flex-direction: column; background: var(--side); z-index: 10; transition: 0.3s; }
        .chat-item { padding: 12px 16px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid #222d34; position: relative; }
        .chat-item:hover { background: #202c33; }
        
        /* Notifikasi Badge */
        .badge { background: var(--green); color: #000; font-weight: bold; font-size: 12px; min-width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: auto; }
        
        /* Status Centang (Simulasi) */
        .status-icon { font-size: 14px; margin-left: 5px; color: #8696a0; }
        .status-read { color: #53bdeb !important; }

        .main { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #0b141a; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 80%; position: relative; font-size: 15px; }
        .msg.me { align-self: flex-end; background: var(--msg-me); border-top-right-radius: 0; }
        .msg.them { align-self: flex-start; background: var(--msg-them); border-top-left-radius: 0; }
        
        .modal { position: fixed; inset: 0; background: var(--dark); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
        .input-bar { background: var(--head); padding: 10px; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background: #2a3942; border: none; padding: 12px; border-radius: 20px; color: white; outline: none; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; height: 100%; }
            .sidebar.hide { transform: translateX(-100%); }
        }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div style="background: var(--head); padding: 30px; border-radius: 10px; text-align: center;">
            <input type="text" id="reg-id" placeholder="ID Unik Anda" style="margin-bottom: 10px; width: 100%;"><br>
            <button onclick="register()" style="background: var(--green); padding: 10px 20px; border: none; cursor: pointer;">Masuk</button>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="input-bar">
            <b id="my-id-display"></b>
            <button onclick="addFriend()" style="margin-left: auto;">+ Tambah Teman</button>
        </div>
        <div id="friend-list"></div>
    </div>

    <div class="main">
        <div class="input-bar" id="chat-header">
            <button onclick="backToList()" class="mobile-only">←</button>
            <b id="chat-title">Pilih Teman</b>
        </div>
        <div id="messages"></div>
        <form class="input-bar hidden" id="chat-form">
            <input type="text" id="msg-input" placeholder="Ketik pesan..." autocomplete="off">
            <button type="submit" id="send-btn">KIRIM</button>
        </form>
    </div>

<script>
    let peer, myID = localStorage.getItem('wid');
    let friends = JSON.parse(localStorage.getItem('wfriends') || '{}');
    let activeChat = null;
    let connections = {}; // Menyimpan koneksi aktif agar tidak putus nyambung

    if(myID) { document.getElementById('setup-modal').classList.add('hidden'); initPeer(); }

    function register() {
        const id = document.getElementById('reg-id').value.trim().toLowerCase();
        if(id) { localStorage.setItem('wid', id); location.reload(); }
    }

    function initPeer() {
        document.getElementById('my-id-display').innerText = "ID: " + myID;
        peer = new Peer(myID);

        peer.on('open', () => renderFriends());

        // Menangani pesan masuk (Bahkan saat tidak sedang chat)
        peer.on('connection', conn => {
            connections[conn.peer] = conn;
            conn.on('data', data => handleIncoming(conn.peer, data));
        });
    }

    function addFriend() {
        const id = prompt("Masukkan ID teman:").toLowerCase().trim();
        if(id && id !== myID) {
            if(!friends[id]) friends[id] = { logs: [], unread: 0 };
            saveFriends();
            renderFriends();
        }
    }

    function openChat(id) {
        activeChat = id;
        friends[id].unread = 0; // Hapus notifikasi saat dibuka
        saveFriends();
        
        document.getElementById('sidebar').classList.add('hide');
        document.getElementById('chat-title').innerText = "Chat: " + id;
        document.getElementById('chat-form').classList.remove('hidden');
        
        // Pastikan koneksi terjalin
        if(!connections[id] || !connections[id].open) {
            const conn = peer.connect(id);
            conn.on('open', () => {
                connections[id] = conn;
                // Kirim sinyal "Read" saat chat dibuka
                conn.send({ type: 'read-receipt' });
            });
            conn.on('data', data => handleIncoming(id, data));
        } else {
            connections[id].send({ type: 'read-receipt' });
        }

        renderMessages(id);
        renderFriends();
    }

    function handleIncoming(id, data) {
        if(!friends[id]) friends[id] = { logs: [], unread: 0 };

        if(data.type === 'chat') {
            friends[id].logs.push({ side: 'them', text: data.text, time: data.time, read: true });
            if(activeChat !== id) {
                friends[id].unread++;
            } else {
                // Jika sedang buka chat, beri tahu pengirim bahwa sudah dibaca
                if(connections[id]) connections[id].send({ type: 'read-receipt' });
            }
        } 
        
        if(data.type === 'read-receipt') {
            // Ubah centang jadi biru untuk semua pesan 'me'
            friends[id].logs.forEach(m => { if(m.side === 'me') m.read = true; });
        }

        saveFriends();
        if(activeChat === id) renderMessages(id);
        renderFriends();
    }

    // Fungsi Kirim Pesan (Enter & Klik)
    document.getElementById('chat-form').onsubmit = e => {
        e.preventDefault();
        const inp = document.getElementById('msg-input');
        const val = inp.value.trim();
        if(!val || !activeChat) return;

        const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const msgObj = { side: 'me', text: val, time: time, read: false };

        // Simpan ke riwayat sendiri
        friends[activeChat].logs.push(msgObj);
        saveFriends();
        renderMessages(activeChat);
        inp.value = "";

        // Kirim ke teman
        if(connections[activeChat] && connections[activeChat].open) {
            connections[activeChat].send({ type: 'chat', text: val, time: time });
        } else {
            // Re-koneksi otomatis jika putus
            const conn = peer.connect(activeChat);
            conn.on('open', () => {
                connections[activeChat] = conn;
                conn.send({ type: 'chat', text: val, time: time });
            });
        }
    };

    function renderFriends() {
        const container = document.getElementById('friend-list');
        container.innerHTML = "";
        for(let id in friends) {
            const f = friends[id];
            const badge = f.unread > 0 ? `<div class="badge">${f.unread}</div>` : "";
            container.innerHTML += `
                <div class="chat-item" onclick="openChat('${id}')">
                    <div><b>${id}</b></div>
                    ${badge}
                </div>`;
        }
    }

    function renderMessages(id) {
        const container = document.getElementById('messages');
        container.innerHTML = "";
        friends[id].logs.forEach(m => {
            // Centang Biru Logika
            const tick = m.side === 'me' ? `<span class="status-icon ${m.read ? 'status-read' : ''}">✔✔</span>` : '';
            container.innerHTML += `
                <div class="msg ${m.side}">
                    ${m.text}
                    <div style="font-size:10px; opacity:0.6; text-align:right">
                        ${m.time} ${tick}
                    </div>
                </div>`;
        });
        container.scrollTop = container.scrollHeight;
    }

    function backToList() { document.getElementById('sidebar').classList.remove('hide'); activeChat = null; }
    function saveFriends() { localStorage.setItem('wfriends', JSON.stringify(friends)); }
</script>
</body>
</html>
