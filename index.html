<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>LiteChat Pro - Stable</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --dark: #111b21; --head: #202c33; --green: #00a884; --msg-me: #005c4b; --msg-them: #202c33; --text: #e9edef; }
        body { margin: 0; background: #0b141a; color: var(--text); font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; border-right: 1px solid #333; display: flex; flex-direction: column; background: var(--dark); }
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .header { background: var(--head); padding: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; }
        .chat-item { padding: 15px; border-bottom: 1px solid #222; cursor: pointer; }
        .chat-item:hover { background: #2a3942; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .msg { padding: 10px; border-radius: 8px; max-width: 70%; font-size: 14px; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--msg-me); }
        .msg.them { align-self: flex-start; background: var(--msg-them); }
        .input-area { background: var(--head); padding: 15px; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #2a3942; color: white; outline: none; }
        button { background: var(--green); border: none; padding: 5px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="header">
        <div><b id="my-name"></b><br><small id="my-id" style="color:var(--green)"></small></div>
        <button onclick="addFriend()">+</button>
    </div>
    <div id="friend-list"></div>
</div>
<div class="main">
    <div class="header"><b id="chat-title">Pilih Teman</b></div>
    <div id="messages"></div>
    <form id="chat-form" class="input-area" style="display:none">
        <input type="text" id="msg-input" placeholder="Ketik pesan..." autocomplete="off">
        <button type="submit">Kirim</button>
    </form>
</div>
<script>
    // System Anti-Hilang saat Refresh
    let myID = localStorage.getItem('wid_final') || prompt("Masukkan ID Anda:").toLowerCase();
    let myName = localStorage.getItem('wname_final') || prompt("Masukkan Nama Anda:");
    localStorage.setItem('wid_final', myID);
    localStorage.setItem('wname_final', myName);

    let chats = JSON.parse(localStorage.getItem('saved_chats_final') || '{}');
    let activeChat = null;

    document.getElementById('my-name').innerText = myName;
    document.getElementById('my-id').innerText = "@" + myID;

    const peer = new Peer(myID);
    peer.on('open', () => renderFriends());
    peer.on('connection', conn => {
        conn.on('data', data => {
            if (!chats[conn.peer]) chats[conn.peer] = { name: data.sender || conn.peer, logs: [] };
            chats[conn.peer].logs.push({ side: 'them', text: data.text });
            saveAndRefresh();
        });
    });

    function addFriend() {
        const id = prompt("Masukkan ID Teman:").toLowerCase();
        if (id && id !== myID) {
            if (!chats[id]) chats[id] = { name: id, logs: [] };
            saveAndRefresh();
            openChat(id);
        }
    }

    function openChat(id) {
        activeChat = id;
        document.getElementById('chat-title').innerText = chats[id].name;
        document.getElementById('chat-form').style.display = 'flex';
        renderMessages();
    }

    document.getElementById('chat-form').onsubmit = e => {
        e.preventDefault();
        const inp = document.getElementById('msg-input');
        if (!inp.value) return;
        chats[activeChat].logs.push({ side: 'me', text: inp.value });
        const conn = peer.connect(activeChat);
        conn.on('open', () => {
            conn.send({ text: inp.value, sender: myName }); 
            saveAndRefresh();
        });
        inp.value = "";
    };

    function saveAndRefresh() {
        localStorage.setItem('saved_chats_final', JSON.stringify(chats));
        renderFriends();
        if (activeChat) renderMessages();
    }

    function renderFriends() {
        const list = document.getElementById('friend-list');
        list.innerHTML = "";
        Object.keys(chats).forEach(id => {
            list.innerHTML += `<div class="chat-item" onclick="openChat('${id}')"><b>${chats[id].name}</b></div>`;
        });
    }

    function renderMessages() {
        const container = document.getElementById('messages');
        container.innerHTML = "";
        chats[activeChat].logs.forEach(m => {
            container.innerHTML += `<div class="msg ${m.side}">${m.text}</div>`;
        });
        container.scrollTop = container.scrollHeight;
    }
</script>
</body>
</html>
